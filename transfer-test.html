<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Transfer test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:20px;background:#f6f7fb;color:#07101a}
    .card{max-width:640px;margin:24px auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e8f0}
    #confirm-send{margin-top:12px;padding:12px 16px;border-radius:12px;border:none;background:linear-gradient(90deg,#8F6BFF,#00D4FF);color:#07101a;font-weight:800;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    td,th{padding:8px;border-bottom:1px solid #f0f0f5;font-size:14px}
    #tx-tbody tr:first-child td{background:#fffbe6}
  </style>
</head>
<body>
  <div class="card">
    <h3>Transfer funds (test)</h3>

    <label for="from-account">From</label>
    <select id="from-account">
      <option value="checking">Checking •••• 3364 — $62345.67</option>
      <option value="savings">Savings •••• 1122 — $758910.11</option>
    </select>

    <label for="to-recipient">To</label>
    <input id="to-recipient" placeholder="Recipient name, email or account" value="453456789">

    <label for="amount">Amount</label>
    <input id="amount" type="number" step="0.01" value="45.00">

    <button id="confirm-send">Confirm</button>
    <button id="reset" style="margin-left:8px">Reset balances</button>

    <table aria-label="Transactions" id="tx-table">
      <thead><tr><th>Date</th><th>Desc</th><th style="text-align:right">Amount</th><th style="text-align:right">Balance</th></tr></thead>
      <tbody id="tx-tbody"></tbody>
    </table>
  </div>

  <script>
  (function(){
    const BAL_KEY = 'citi_bal_test_bal';
    const TX_KEY  = 'citi_bal_test_txs';

    function loadBalances(){ try { return JSON.parse(localStorage.getItem(BAL_KEY)) || { checking:62345.67, savings:758910.11 }; } catch(e){ return { checking:62345.67, savings:758910.11 }; }
    }
    function saveBalances(b){ localStorage.setItem(BAL_KEY, JSON.stringify(b)); }
    function loadTxs(){ try { return JSON.parse(localStorage.getItem(TX_KEY)) || []; } catch(e){ return []; } }
    function saveTxs(txs){ localStorage.setItem(TX_KEY, JSON.stringify(txs)); }

    function fmt(n){ return '$' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function pretty(d){ return new Date(d).toLocaleString(); }

    function appendTx(tx){
      const tbody = document.getElementById('tx-tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${pretty(tx.date)}</td><td>${tx.desc}</td><td style="text-align:right">${fmt(tx.amount)}</td><td style="text-align:right">${fmt(tx.balance)}</td>`;
      tbody.insertBefore(tr, tbody.firstChild);
    }

    function printReceiptResilient(tx){
      // try popup
      try {
        const w = window.open('', '_blank', 'width=520,height=720');
        if (w) {
          w.document.open();
          w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Receipt</title><style>body{font-family:system-ui;padding:20px}</style></head><body>
            <h2>Receipt</h2>
            <div>Date: ${pretty(tx.date)}</div>
            <div>From: ${tx.from}</div>
            <div>To: ${tx.to}</div>
            <div>Amount: ${fmt(tx.amount)}</div>
            <div>Balance: ${fmt(tx.balance)}</div>
            <script>window.onload=function(){ setTimeout(()=>{ window.print(); setTimeout(()=>window.close(),400); },80); };</script>
            </body></html>`);
          w.document.close();
          return;
        }
      } catch(e){}
      // fallback overlay
      const existing = document.getElementById('citi-print-overlay'); if (existing) existing.remove();
      const ov = document.createElement('div');
      ov.id = 'citi-print-overlay';
      ov.style = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;padding:20px';
      ov.innerHTML = `<div style="background:#fff;padding:20px;border-radius:10px;max-width:520px;width:100%">
        <h2>Receipt</h2>
        <div>Date: ${pretty(tx.date)}</div>
        <div>From: ${tx.from}</div>
        <div>To: ${tx.to}</div>
        <div>Amount: ${fmt(tx.amount)}</div>
        <div>Balance: ${fmt(tx.balance)}</div>
        <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
          <button id="citi-close">Close</button>
          <button id="citi-print">Print</button>
        </div>
      </div>`;
      document.body.appendChild(ov);
      document.getElementById('citi-close').addEventListener('click', ()=> ov.remove());
      document.getElementById('citi-print').addEventListener('click', ()=>{
        const printW = window.open('','_blank','width=520,height=720');
        if (!printW) { alert('Allow popups to print'); return; }
        printW.document.open();
        printW.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Receipt</title></head><body>' + ov.innerHTML + '<script>window.onload=function(){ setTimeout(()=>{ window.print(); setTimeout(()=>window.close(),400); },80); };</script></body></html>');
        printW.document.close();
      });
    }

    function commitTransaction(from, to, amount){
      const balances = loadBalances();
      const txs = loadTxs();
      if (!amount || amount <= 0) throw new Error('Invalid amount');
      if (typeof balances[from] !== 'number') balances[from] = Number(balances[from]) || 0;
      balances[from] = Number((balances[from] - amount).toFixed(2));
      saveBalances(balances);
      const tx = { id:'tx_'+Date.now(), date:new Date().toISOString(), from, to, desc:'Transfer', amount:-Math.abs(amount), balance:balances[from] };
      txs.unshift(tx); saveTxs(txs); appendTx(tx);
      printReceiptResilient(tx);
      return tx;
    }

    // UI wiring: single binding only
    const btn = document.getElementById('confirm-send');
    btn.addEventListener('click', function _handler(e){
      e.preventDefault();
      try {
        btn.disabled = true; btn.textContent = 'Processing…';
        const from = document.getElementById('from-account').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const to = document.getElementById('to-recipient').value || '—';
        commitTransaction(from, to, amount);
      } catch(err) {
        alert('Error: ' + (err.message || err));
      } finally {
        setTimeout(()=>{ btn.disabled = false; btn.textContent = 'Confirm'; }, 700);
      }
    });

    // reset balances for testing
    document.getElementById('reset').addEventListener('click', ()=> {
      localStorage.removeItem(BAL_KEY); localStorage.removeItem(TX_KEY); document.getElementById('tx-tbody').innerHTML=''; alert('Reset done');
    });

    // hydrate tx table on load
    (function hydrate(){ const txs = loadTxs(); txs.slice(0,50).forEach(appendTx); })();

  })();
  </script>
</body>
</html>

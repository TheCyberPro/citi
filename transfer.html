<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transfer — Mobile CITI</title>
  <style>
    :root{
      --bg:#0f1724;
      --muted:#9aa4b2;
      --accent:#7c5cff;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    html,body{height:100%;margin:0}
    body{
      background:
        radial-gradient(900px 400px at 10% 10%, rgba(124,92,255,0.10), transparent 6%),
        var(--bg);
      color:#e6eef8;
      -webkit-font-smoothing:antialiased;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px;
    }

    .card{
      width:100%;
      max-width:720px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
      border:1px solid rgba(255,255,255,0.04);
      padding:16px;
      border-radius:12px;
      box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    }

    .brand{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#fff,#f0f0f0)}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted);font-size:13px}

    label{display:block;font-size:13px;color:var(--muted);margin-top:10px;margin-bottom:8px}
    input,button,textarea{width:100%;padding:12px;border-radius:10px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:#e8f0ff;font-size:15px;outline:none}
    .row{display:flex;gap:10px}
    .btn{background:linear-gradient(90deg,var(--accent),#5ec9ff);border:0;padding:12px;border-radius:10px;color:#08101a;font-weight:700;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer;border-radius:10px;padding:10px}

    .meta{font-size:13px;color:var(--muted);margin-top:8px}

    .history{margin-top:14px;display:flex;flex-direction:column;gap:10px;max-height:300px;overflow:auto;padding-right:6px}
    .tx{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;display:flex;justify-content:space-between;align-items:center}
    .tx .left{display:flex;flex-direction:column}
    .tx .title{font-weight:700;font-size:14px}
    .tx .meta{font-size:12px;color:var(--muted);margin-top:4px}

    .balance-row{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .balance-amount{font-weight:800;font-size:20px}

    /* Modal receipt */
    .modal {
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:60;padding:18px;
    }
    .modal.open { display:flex }
    .receipt {
      width:100%;max-width:560px;background:#fff;color:#111;border-radius:10px;padding:18px;box-sizing:border-box;
    }
    .receipt h2{margin:0 0 8px;font-size:18px}
    .receipt .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
    .receipt .row:last-child{border-bottom:0}
    .receipt .amount{font-weight:800;font-size:18px}

    @media (max-width:520px){ .row{flex-direction:column} .receipt{padding:14px} }
  </style>
</head>
<body>
  <div class="card" role="main">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Transfer</h1>
        <div class="muted">Send money to saved recipients or any bank account</div>
      </div>
    </div>

    <form id="transferForm" autocomplete="off" novalidate>
      <label for="recipientName">Recipient name</label>
      <input id="recipientName" name="recipientName" type="text" value="Jane Doe" required />

      <div class="row">
        <div style="flex:1">
          <label for="toAccount">Account number</label>
          <input id="toAccount" name="toAccount" type="text" value="1234567890" inputmode="numeric" required />
        </div>
        <div style="width:120px">
          <label for="bankCode">Bank code</label>
          <input id="bankCode" name="bankCode" type="text" value="012" inputmode="numeric" />
        </div>
      </div>

      <label for="amount">Amount ($)</label>
      <input id="amount" name="amount" type="number" min="1" step="1" value="0" inputmode="numeric" />

      <label for="note">Note (optional)</label>
      <input id="note" name="note" type="text" value="For rent, invoice #123" />

      <div style="display:flex;gap:10px;margin-top:12px">
        <button type="submit" class="btn" style="flex:1">Send transfer</button>
        <button type="button" id="resetBtn" class="btn-ghost" style="width:120px">Reset</button>
      </div>
    </form>

    <div class="balance-row">
      <div class="meta">Available balance</div>
      <div class="balance-amount" id="balanceDisplay">$821,255.78</div>
    </div>
    <div class="meta">This balance updates immediately after each transfer</div>

    <div style="margin-top:16px">
      <div class="muted">Recent activity</div>
      <div class="history" id="historyList" aria-live="polite"></div>
    </div>
  </div>

  <!-- In-page modal receipt (prints via window.print) -->
  <div id="receiptModal" class="modal" role="dialog" aria-hidden="true">
    <div class="receipt" id="receiptContent">
      <!-- populated dynamically -->
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Transaction Receipt</h2>
        <button id="closeReceipt" style="background:#eee;border:0;padding:6px 10px;border-radius:6px;cursor:pointer">Close</button>
      </div>
      <div id="receiptBody" style="margin-top:12px"></div>
      <div style="margin-top:12px;font-size:13px;color:#666">Keep this receipt for your records</div>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="printReceiptBtn" class="btn" style="background:#111;color:#fff">Print</button>
      </div>
    </div>
  </div>

  <script>
    // Storage keys (shared)
    const BALANCE_KEY = 'balance';
    const TX_KEY = 'transactions';

    // Utilities
    const safeParse = (k, f) => { try { return JSON.parse(localStorage.getItem(k)) ?? f } catch { return f } };
    const format = (n) => '¥' + Number(n).toLocaleString();
    const uid = () => 'tx_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
    const escapeHtml = s => { if (s == null) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); };

    // Storage primitives (no synthetic storage events)
    function initStorage() {
      if (!localStorage.getItem(BALANCE_KEY)) localStorage.setItem(BALANCE_KEY, JSON.stringify({ amount: 0, currency: 'USD' }));
      if (!localStorage.getItem(TX_KEY)) localStorage.setItem(TX_KEY, JSON.stringify([]));
    }
    function getBalance() { return safeParse(BALANCE_KEY, { amount: 0, currency: 'USD' }); }
    function setBalance(b) { localStorage.setItem(BALANCE_KEY, JSON.stringify(b)); }
    function getTxs() { return safeParse(TX_KEY, []); }
    function setTxs(txs) { localStorage.setItem(TX_KEY, JSON.stringify(txs)); }

    // Renderers
    function renderBalance() {
      const b = getBalance();
      document.getElementById('balanceDisplay').textContent = format(b.amount);
    }

    function renderHistory() {
      const wrap = document.getElementById('historyList');
      wrap.innerHTML = '';
      const txs = getTxs().slice().reverse();
      if (!txs.length) {
        const none = document.createElement('div');
        none.className = 'tx';
        none.innerHTML = '<div class="left"><div class="title">No transactions</div><div class="meta">Your recent debits will appear here</div></div><div class="meta">—</div>';
        wrap.appendChild(none);
        return;
      }
      txs.forEach(tx => {
        if (tx.type !== 'debit') return;
        const el = document.createElement('div');
        el.className = 'tx';
        el.innerHTML = `<div class="left"><div class="title">${escapeHtml(tx.description || 'Transfer')}</div><div class="meta">${new Date(tx.timestamp).toLocaleString()} · To ${escapeHtml(tx.toAccount || tx.to || 'external')}</div></div><div class="meta">${format(tx.amount)}</div>`;
        wrap.appendChild(el);
      });
    }

    // Modal helpers
    const modal = document.getElementById('receiptModal');
    const receiptBody = document.getElementById('receiptBody');
    const closeReceipt = document.getElementById('closeReceipt');
    const printReceiptBtn = document.getElementById('printReceiptBtn');

    function openReceiptModal(tx) {
      // build receipt HTML
      receiptBody.innerHTML = `
        <div style="padding-top:8px">
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Transaction ID</strong></div><div>${escapeHtml(tx.id)}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Recipient</strong></div><div>${escapeHtml(tx.recipientName)}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Account</strong></div><div>${escapeHtml(tx.toAccount)}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Bank code</strong></div><div>${escapeHtml(tx.bankCode || '—')}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Amount</strong></div><div class="amount">${format(tx.amount)}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Note</strong></div><div>${escapeHtml(tx.description || '—')}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Date</strong></div><div>${new Date(tx.timestamp).toLocaleString()}</div></div>
          <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Status</strong></div><div>${tx.success ? 'Completed' : 'Failed'}</div></div>
        </div>
      `;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      // Attach print behavior
      printReceiptBtn.onclick = () => {
        // Temporarily open print with only receipt content
        // Create a print-only iframe to avoid printing the rest of the app UI
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`
          <!doctype html><html><head><meta charset="utf-8"><title>Receipt</title>
          <style>body{font-family:Arial,Helvetica,sans-serif;color:#111;padding:18px} .wrap{max-width:600px;margin:0 auto} .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee} .amount{font-weight:800;font-size:18px}</style>
          </head><body><div class="wrap">${receiptBody.innerHTML}</div></body></html>
        `);
        doc.close();
        // Wait a tick then print
        iframe.onload = () => {
          try {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
          } catch (err) {
            // fallback: window.print will print whole app
            window.print();
          } finally {
            setTimeout(() => { document.body.removeChild(iframe); }, 700);
          }
        };
        // If iframe load doesn't fire, trigger print anyway after short delay
        setTimeout(() => {
          try { iframe.contentWindow.print(); } catch {}
        }, 300);
      };
    }

    function closeReceiptModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      receiptBody.innerHTML = '';
    }

    closeReceipt.addEventListener('click', closeReceiptModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeReceiptModal(); });

    // Transfer flow
    document.getElementById('transferForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const recipientName = document.getElementById('recipientName').value.trim();
      const toAccount = document.getElementById('toAccount').value.trim();
      const bankCode = document.getElementById('bankCode').value.trim();
      const amount = Math.floor(Number(document.getElementById('amount').value || 0));
      const description = document.getElementById('note').value.trim();

      if (!recipientName) { alert('Enter recipient name'); return; }
      if (!toAccount) { alert('Enter account number'); return; }
      if (!amount || amount <= 0) { alert('Enter an amount greater than 0'); return; }

      const balance = getBalance();
      if (amount > balance.amount) { alert('Insufficient funds'); return; }

      const tx = {
        id: uid(),
        timestamp: Date.now(),
        recipientName,
        toAccount,
        bankCode,
        amount,
        currency: 'USD',
        description,
        type: 'debit',
        success: true
      };

      // Persist: deduct and append
      const newBal = { amount: Number((balance.amount - amount).toFixed(0)), currency: 'USD' };
      setBalance(newBal);
      const txs = getTxs();
      txs.push(tx);
      setTxs(txs);

      // Update UI
      renderBalance();
      renderHistory();

      // Open in-page receipt modal (avoids popups)
      openReceiptModal(tx);

      // Reset form but keep minimal defaults
      document.getElementById('transferForm').reset();
      document.getElementById('recipientName').value = recipientName; // keep UX stable on mobile
    });

    document.getElementById('resetBtn').addEventListener('click', function () {
      if (confirm('Reset the transfer form?')) document.getElementById('transferForm').reset();
    });

    // Storage listeners for cross-tab updates (do not trigger from code)
    window.addEventListener('storage', function (e) {
      if (e.key === BALANCE_KEY) renderBalance();
      if (e.key === TX_KEY) renderHistory();
    });

    // Init
    function init() {
      initStorage();
      renderBalance();
      renderHistory();
      // Prefill sample values for convenience (remove if undesired)
      document.getElementById('recipientName').value = 'Jane Doe';
      document.getElementById('toAccount').value = '1234567890';
      document.getElementById('bankCode').value = '012';
      document.getElementById('amount').value = '0';
      document.getElementById('note').value = 'For rent, invoice #123';
      // Expose debug helpers (read-only)
      window._citi = { getBalance, getTxs };
    }

    // Expose storage helpers
    function getBalance() { return safeParse(BALANCE_KEY, { amount: 0, currency: 'USD' }); }
    function setBalance(b) { localStorage.setItem(BALANCE_KEY, JSON.stringify(b)); }
    function getTxs() { return safeParse(TX_KEY, []); }
    function setTxs(txs) { localStorage.setItem(TX_KEY, JSON.stringify(txs)); }

    init();
  </script>
</body>
</html>

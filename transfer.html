<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transfer — CITI</title>

  <!-- Inline CSS matching a luxury/withdraw look (drop-in for withdraw.css) -->
  <style>
    :root{
      --bg:#0f1222;
      --card:#0f1724;
      --muted:#97a0b5;
      --accent:#7c5cff;
      --glass: rgba(255,255,255,0.04);
      --success:#18c295;
      --danger:#ff6b6b;
      --text:#e6eef8;
      --shadow: 0 6px 24px rgba(2,6,23,0.6);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg, #071028 0%, #071026 50%, #0b1322 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:32px;
      display:flex;
      align-items:flex-start;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:980px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      box-shadow: var(--shadow);
      padding:28px;
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:20px;
    }

    header.site-header{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:6px;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:44px;
      height:44px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--accent),#4ca1ff);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:white;
      box-shadow:0 6px 18px rgba(124,92,255,0.18);
    }
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    /* Left column (form) */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;
      padding:20px;
      box-shadow: 0 8px 32px rgba(2,8,20,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }

    input[type="text"], input[type="number"], select{
      width:100%;
      padding:12px 14px;
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      color:var(--text);
      border-radius:8px;
      font-size:14px;
      margin-bottom:14px;
    }

    .row{
      display:flex;
      gap:12px;
    }
    .row .col{flex:1}

    .actions{
      display:flex;
      gap:12px;
      margin-top:6px;
    }

    .btn{
      padding:12px 16px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
      display:inline-flex;
      gap:10px;
      align-items:center;
    }
    .btn-primary{
      background: linear-gradient(90deg,var(--accent),#4ca1ff);
      color:white;
      box-shadow: 0 8px 24px rgba(124,92,255,0.18);
    }
    .btn-ghost{
      background:transparent;
      color:var(--text);
      border:1px solid rgba(255,255,255,0.04);
    }

    /* Right column (summary + history) */
    .summary{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .balance{
      padding:18px;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.03);
    }
    .balance .label{color:var(--muted);font-size:13px}
    .balance .amount{font-size:28px;font-weight:700;margin-top:6px}

    .small{
      font-size:13px;color:var(--muted)
    }

    .history{
      max-height:360px;
      overflow:auto;
      padding:12px;
      border-radius:10px;
      background:rgba(255,255,255,0.01);
      border:1px solid rgba(255,255,255,0.03);
    }

    .tx{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:8px;
      align-items:center;
      margin-bottom:8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.005), transparent);
      border:1px solid rgba(255,255,255,0.02);
    }
    .tx .meta{display:flex;flex-direction:column}
    .tx .meta .who{font-weight:600}
    .tx .meta .when{font-size:12px;color:var(--muted)}
    .tx .amt{font-weight:700}
    .tx.credit .amt{color:var(--success)}
    .tx.debit .amt{color:var(--danger)}

    /* Receipt modal */
    .receipt-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(2,6,23,0.6);
      z-index:60;
    }
    .receipt-card{
      width:520px;
      max-width:95%;
      background:linear-gradient(180deg,#071020,#0f1324);
      border-radius:12px;
      padding:18px;
      color:var(--text);
      box-shadow:0 12px 48px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    .receipt-card h3{margin:0 0 8px 0}
    .receipt-row{display:flex;justify-content:space-between;margin:6px 0;color:var(--muted)}
    .receipt-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Responsive */
    @media (max-width:980px){
      .container{grid-template-columns:1fr; padding:18px}
      header.site-header{flex-direction:column;align-items:flex-start;gap:6px}
    }
  </style>
</head>
<body>
  <main class="container" role="main">
    <header class="site-header">
      <div class="brand">
        <div class="logo">C</div>
        <div>
          <h1>Transfer funds</h1>
          <p class="lead">Send money instantly to saved recipients or any bank account</p>
        </div>
      </div>

      <div style="display:flex;gap:12px;align-items:center">
        <div class="small">Logged in as <strong>AUTHOR</strong></div>
        <button class="btn btn-ghost" id="nav-dashboard">Dashboard</button>
      </div>
    </header>

    <!-- Left: Transfer form -->
    <section class="card" aria-labelledby="transfer-title">
      <h2 id="transfer-title" style="margin-top:0">Make a transfer</h2>

      <form id="transferForm" onsubmit="return false" autocomplete="off">
        <label for="toName">Recipient name</label>
        <input id="toName" name="toName" type="text" placeholder="Jane Doe" required />

        <div class="row">
          <div class="col">
            <label for="toAccount">Account number</label>
            <input id="toAccount" name="toAccount" type="text" placeholder="1234567890" pattern="[0-9]{6,20}" required />
          </div>
          <div class="col">
            <label for="bank">Bank code</label>
            <input id="bank" name="bank" type="text" placeholder="012" required />
          </div>
        </div>

        <label for="amount">Amount</label>
        <input id="amount" name="amount" type="number" min="1" step="0.01" placeholder="0.00" required />

        <label for="note">Note (optional)</label>
        <input id="note" name="note" type="text" placeholder="For rent, invoice #123" />

        <div class="actions">
          <button id="btnTransfer" class="btn btn-primary" type="button">Send transfer</button>
          <button id="btnReset" class="btn btn-ghost" type="reset">Reset</button>
        </div>

        <p id="formMessage" class="small" style="margin-top:12px"></p>
      </form>
    </section>

    <!-- Right: Balance & history -->
    <aside class="summary">
      <div class="balance card">
        <div class="label">Available balance</div>
        <div class="amount" id="balanceAmount">¥0.00</div>
        <div class="small" style="margin-top:8px">This balance updates immediately after each transfer</div>
      </div>

      <div class="card" style="padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div><strong>Recent activity</strong><div class="small">Latest transfers and debits</div></div>
          <button id="clearHistory" class="btn btn-ghost">Clear</button>
        </div>
        <div id="history" class="history" aria-live="polite"></div>
      </div>
    </aside>

    <!-- Receipt modal / print content -->
    <div id="receiptModal" class="receipt-modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="receipt-card" role="document">
        <h3>Transaction receipt</h3>
        <div id="receiptContent">
          <div class="receipt-row"><span class="small">Status</span><strong id="rStatus">Success</strong></div>
          <div class="receipt-row"><span class="small">Date</span><span id="rDate"></span></div>
          <div class="receipt-row"><span class="small">Amount</span><span id="rAmount"></span></div>
          <div class="receipt-row"><span class="small">To</span><span id="rTo"></span></div>
          <div class="receipt-row"><span class="small">Account</span><span id="rAccount"></span></div>
          <div class="receipt-row"><span class="small">Bank</span><span id="rBank"></span></div>
          <div class="receipt-row"><span class="small">Note</span><span id="rNote"></span></div>
          <div class="receipt-row"><span class="small">Balance after</span><span id="rBalanceAfter"></span></div>
        </div>

        <div class="receipt-actions">
          <button id="printBtn" class="btn btn-primary">Print</button>
          <button id="closeReceipt" class="btn btn-ghost">Close</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Script: handles transfers, balance, history, receipt & persistence -->
  <script>
    /* Data keys for localStorage */
    const BALANCE_KEY = 'citi_balance_v1';
    const TX_KEY = 'citi_txs_v1';

    /* Utility */
    function fmt(amount){
      const n = Number(amount) || 0;
      return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(Math.round(n));
    }
    function nowIso(){ return new Date().toISOString(); }
    function humanDate(iso){
      const d = new Date(iso);
      return d.toLocaleString();
    }

    /* Initialize with sensible default if empty */
    function initStorage(){
      if(localStorage.getItem(BALANCE_KEY) === null){
        // set a default starting balance (adjust as desired)
        localStorage.setItem(BALANCE_KEY, String(250000)); // 250,000 JPY
      }
      if(!Array.isArray(JSON.parse(localStorage.getItem(TX_KEY) || 'null'))){
        localStorage.setItem(TX_KEY, JSON.stringify([]));
      }
    }

    /* Getters & setters */
    function getBalance(){ return Number(localStorage.getItem(BALANCE_KEY) || 0); }
    function setBalance(v){ localStorage.setItem(BALANCE_KEY, String(Math.round(v))); renderBalance(); }
    function getTxs(){ return JSON.parse(localStorage.getItem(TX_KEY) || '[]'); }
    function pushTx(tx){ const arr = getTxs(); arr.unshift(tx); localStorage.setItem(TX_KEY, JSON.stringify(arr)); renderHistory(); }

    /* UI elements */
    const balanceEl = document.getElementById('balanceAmount');
    const historyEl = document.getElementById('history');
    const form = document.getElementById('transferForm');
    const btn = document.getElementById('btnTransfer');
    const msg = document.getElementById('formMessage');

    /* Receipt modal elements */
    const receiptModal = document.getElementById('receiptModal');
    const rDate = document.getElementById('rDate');
    const rAmount = document.getElementById('rAmount');
    const rTo = document.getElementById('rTo');
    const rAccount = document.getElementById('rAccount');
    const rBank = document.getElementById('rBank');
    const rNote = document.getElementById('rNote');
    const rBalanceAfter = document.getElementById('rBalanceAfter');
    const printBtn = document.getElementById('printBtn');
    const closeReceipt = document.getElementById('closeReceipt');

    /* Render functions */
    function renderBalance(){
      balanceEl.textContent = fmt(getBalance());
    }

    function renderHistory(){
      const txs = getTxs();
      historyEl.innerHTML = txs.length ? txs.map(txHtml).join('') : '<div class="small">No transactions yet</div>';
    }

    function txHtml(tx){
      // single-line per rules
      const cls = tx.type === 'credit' ? 'tx credit' : 'tx debit';
      const when = humanDate(tx.date);
      const who = tx.toName || tx.memo || '—';
      const amt = (tx.type === 'debit' ? '-' : '+') + new Intl.NumberFormat('ja-JP', {style:'currency',currency:'JPY'}).format(Math.round(tx.amount));
      return `<div class="${cls}"><div class="meta"><div class="who">${escapeHtml(who)}</div><div class="when">${when}</div></div><div class="amt">${amt}</div></div>`;
    }

    /* Basic escaping */
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m])); }

    /* Transfer logic */
    function validateForm(data){
      const amt = Number(data.amount);
      if(!data.toName || !data.toAccount || isNaN(amt) || amt <= 0) return 'Please complete recipient and amount fields with a value greater than zero.';
      if(!/^[0-9]{6,20}$/.test(data.toAccount)) return 'Account number must be 6–20 digits.';
      return null;
    }

    function onTransfer(){
      msg.textContent = '';
      const data = {
        toName: document.getElementById('toName').value.trim(),
        toAccount: document.getElementById('toAccount').value.trim(),
        bank: document.getElementById('bank').value.trim(),
        amount: Number(document.getElementById('amount').value),
        note: document.getElementById('note').value.trim(),
        date: nowIso(),
      };

      const err = validateForm(data);
      if(err){ msg.textContent = err; return; }

      const current = getBalance();
      if(data.amount > current){
        msg.textContent = 'Insufficient balance for this transfer.';
        return;
      }

      // Deduct balance immediately
      const after = current - Math.round(data.amount);
      setBalance(after);

      // Create transaction record (debit)
      const tx = {
        id: 'tx_' + Date.now(),
        type: 'debit',
        amount: Math.round(data.amount),
        toName: data.toName,
        toAccount: data.toAccount,
        bank: data.bank,
        note: data.note,
        date: data.date,
      };
      pushTx(tx);

      // Also create a small credit record on the "recipient" side if desired (not deducted from sender)
      // pushTx({ ...tx, type: 'credit', id: 'txc_' + Date.now() }); // optional; commented out

      // Show receipt and enable printing
      showReceipt(tx, after);

      // Reset form but keep recipient for convenience
      document.getElementById('amount').value = '';
      document.getElementById('note').value = '';
      msg.textContent = 'Transfer completed';
      msg.style.color = 'var(--success)';
      setTimeout(()=>{ msg.textContent=''; msg.style.color=''; }, 3500);
    }

    /* Receipt: populate and show */
    function showReceipt(tx, balanceAfter){
      rDate.textContent = humanDate(tx.date);
      rAmount.textContent = fmt(tx.amount);
      rTo.textContent = escapeHtml(tx.toName);
      rAccount.textContent = escapeHtml(tx.toAccount);
      rBank.textContent = escapeHtml(tx.bank || '—');
      rNote.textContent = escapeHtml(tx.note || '—');
      rBalanceAfter.textContent = fmt(balanceAfter);

      receiptModal.style.display = 'flex';
      receiptModal.setAttribute('aria-hidden', 'false');
      // prepare print content by cloning innerHTML
      printBtn.onclick = () => printReceipt(tx, balanceAfter);
    }

    function closeModal(){
      receiptModal.style.display = 'none';
      receiptModal.setAttribute('aria-hidden', 'true');
    }

    /* Print: opens print dialog with a clean receipt markup */
    function printReceipt(tx, balanceAfter){
      const printWin = window.open('', '_blank', 'toolbar=no,location=no,menubar=no');
      if(!printWin) { alert('Popup blocked. Please allow popups to print the receipt.'); return; }

      const html = `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Receipt</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;color:#0b1220;padding:24px}
  .wrap{max-width:540px;margin:0 auto}
  h1{font-size:18px;margin-bottom:8px}
  .row{display:flex;justify-content:space-between;margin:8px 0}
  .muted{color:#666;font-size:13px}
  .amt{font-size:20px;font-weight:700;margin-top:8px}
  .footer{margin-top:24px;color:#444;font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Transaction receipt</h1>
    <div class="row"><div class="muted">Date</div><div>${humanDate(tx.date)}</div></div>
    <div class="row"><div class="muted">Recipient</div><div>${escapeHtml(tx.toName)}</div></div>
    <div class="row"><div class="muted">Account</div><div>${escapeHtml(tx.toAccount)}</div></div>
    <div class="row"><div class="muted">Bank</div><div>${escapeHtml(tx.bank || '—')}</div></div>
    <div class="row"><div class="muted">Note</div><div>${escapeHtml(tx.note || '—')}</div></div>
    <div class="row"><div class="muted">Amount</div><div class="amt">${fmt(tx.amount)}</div></div>
    <div class="row"><div class="muted">Balance after</div><div>${fmt(balanceAfter)}</div></div>
    <div class="footer">Reference: ${tx.id}</div>
  </div>
  <script>window.onload = function(){ window.print(); setTimeout(()=>window.close(), 600); };</script>
</body>
</html>
      `;
      printWin.document.open();
      printWin.document.write(html);
      printWin.document.close();
    }

    /* Dashboard navigation: opens dashboard.html if present; still update localStorage for dashboard to read */
    document.getElementById('nav-dashboard').addEventListener('click', ()=>{
      // try to navigate to dashboard if exists; otherwise stay
      window.location.href = 'dashboard.html';
    });

    document.getElementById('closeReceipt').addEventListener('click', closeModal);
    receiptModal.addEventListener('click', (e)=>{ if(e.target === receiptModal) closeModal(); });

    document.getElementById('clearHistory').addEventListener('click', ()=>{
      if(!confirm('Clear transaction history? This cannot be undone.')) return;
      localStorage.setItem(TX_KEY, JSON.stringify([]));
      renderHistory();
    });

    btn.addEventListener('click', onTransfer);

    /* On load */
    (function(){
      initStorage();
      renderBalance();
      renderHistory();

      // If this page is opened after an external deposit, the dashboard may have pushed a transaction
      // Observe storage changes (other tabs) to update UI
      window.addEventListener('storage', (e)=>{
        if(e.key === BALANCE_KEY) renderBalance();
        if(e.key === TX_KEY) renderHistory();
      });
    })();

    /* Expose for debug in console if needed */
    window._citi = {
      getBalance, setBalance, getTxs, pushTx
    };
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>CITI â€” Transfer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

<style>
:root{
  --bg:#0b1220; --panel:#07101a; --card:#0f1724;
  --muted:#98A0AD; --text:#E9F2FF; --accent:#9C7CFF; --accent-2:#00D4FF;
  --success:#7CFFCC; --danger:#FF7A7A;
  --radius:12px; --container:1180px; --gap:16px;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(600px 380px at 10% 10%, rgba(156,124,255,0.06), transparent 6%),
    radial-gradient(500px 300px at 90% 85%, rgba(0,212,255,0.03), transparent 8%),
    var(--bg);
  color:var(--text);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.45;
  letter-spacing:-0.01em;
  padding-bottom:100px;
}
.container{max-width:var(--container);margin:0 auto;padding:0 20px}

/* Header */
header.site-header{position:sticky;top:0;z-index:1200;padding-top:8px}
.header-top{display:flex;align-items:center;justify-content:space-between;padding:10px 0;background:linear-gradient(180deg, rgba(6,10,18,0.6), rgba(6,10,18,0.45));border-bottom:1px solid rgba(255,255,255,0.02);backdrop-filter:blur(6px)}
.nav-toggle{width:44px;height:44px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:grid;place-items:center;background:transparent;cursor:pointer}
.nav-toggle span{display:block;width:18px;height:2px;background:var(--muted);border-radius:2px}
.header-right .logo img{height:36px}
.header-sub{display:flex;align-items:center;padding:10px 0}
.secure-line{font-size:0.95rem;color:var(--muted)}
.member-line{font-size:0.88rem;color:var(--muted)}

/* Overlay */
.menu-overlay{display:none;position:fixed;inset:0;z-index:1500}
.overlay-panel{position:relative;max-width:360px;height:100%;right:0;background:var(--card);padding:18px;border-left:1px solid rgba(255,255,255,0.02)}

/* Layout */
main{padding:26px 0}
.grid{display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
.panel{padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 50px rgba(2,6,23,0.6)}
h1{margin:0 0 12px 0;font-size:1.35rem}
.muted{color:var(--muted)}

/* Form */
.form-group{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
label{font-weight:600}
input[type="text"], input[type="number"], select, textarea { padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text); }
.inline-row{display:flex;gap:12px}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#07101a;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px;color:var(--text);cursor:pointer}
.preview{margin-top:12px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.preview-row{display:flex;justify-content:space-between;gap:8px;padding:6px 0}

/* Right column */
.side-card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.03)}
.quick-list{display:flex;flex-direction:column;gap:8px}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:2200}
.modal{background:var(--card);padding:18px;border-radius:12px;width:520px;max-width:94%;border:1px solid rgba(255,255,255,0.03)}
.modal.open{display:block}

/* Responsive */
@media (max-width:1000px){ .grid{grid-template-columns:1fr} }
@media (max-width:720px){ .inline-row{flex-direction:column} .btn-primary{width:100%} }
button:focus, a:focus{outline:2px solid rgba(156,124,255,0.14);outline-offset:2px}
/* Strong primary button for Withdraw / Transfer */
.btn-primary-strong {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  min-height:52px;                 /* large touch target */
  padding:14px 22px;
  border-radius:14px;
  border: none;
  background: linear-gradient(90deg, #8F6BFF 0%, #00D4FF 100%); /* richer gradient */
  color:#07101a;
  font-weight:800;
  font-size:1rem;
  letter-spacing:0.2px;
  box-shadow: 0 18px 50px rgba(12,12,40,0.55), 0 6px 18px rgba(0,212,255,0.06);
  transform: translateZ(0);
  transition: transform .12s ease, box-shadow .12s ease, opacity .12s;
  cursor:pointer;
}

/* Slightly smaller alternate primary */
.btn-primary-strong.alt {
  background: linear-gradient(90deg, #00D4FF 0%, #8F6BFF 100%);
}

/* Secondary (ghost) action with stronger border and hover */
.btn-ghost-strong {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  min-height:48px;
  padding:12px 18px;
  border-radius:12px;
  background:transparent;
  border:1.5px solid rgba(255,255,255,0.08);
  color:var(--text);
  font-weight:700;
  box-shadow: 0 8px 28px rgba(2,6,23,0.35);
  transition: background .12s ease, transform .12s ease;
  cursor:pointer;
}
.btn-ghost-strong:hover { background: rgba(255,255,255,0.02); transform: translateY(-2px); }

/* Hover / active */
.btn-primary-strong:hover { transform: translateY(-2px); box-shadow: 0 28px 70px rgba(12,12,40,0.6); }
.btn-primary-strong:active { transform: translateY(0); box-shadow: 0 12px 28px rgba(12,12,40,0.45); opacity:0.98; }

/* Focus ring for accessibility */
.btn-primary-strong:focus, .btn-ghost-strong:focus {
  outline: 3px solid rgba(156,124,255,0.18);
  outline-offset:4px;
}

/* Responsive adjustments */
@media (max-width:720px){
  .btn-primary-strong { min-height:56px; padding:16px 20px; font-size:1.02rem; border-radius:14px; width:100%; }
  .btn-ghost-strong { width:100%; }
}

/* Icon support */
.btn-primary-strong .btn-icon, .btn-ghost-strong .btn-icon { width:20px;height:20px;display:inline-block;flex:0 0 20px; }

</style>
</head>
<body>
  <!-- Header -->
  <header class="site-header" role="banner">
    <div class="container header-top">
      <button id="nav-toggle" class="nav-toggle" aria-label="Open menu"><span aria-hidden="true"></span></button>
      <div class="header-right"><a class="logo" href="dashboard.html" aria-label="CITI Home"><img src="assets/citi_logo.png" alt="CITI Logo" /></a></div>
    </div>


    <!-- overlay -->
    <div class="menu-overlay" id="menu-overlay" aria-hidden="true">
      <div id="overlay-backdrop" style="position:absolute;inset:0;background:rgba(2,6,23,0.6)"></div>
      <div class="overlay-panel" role="dialog" aria-modal="true">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
          <a href="dashboard.html"><img src="assets/citi_logo.png" alt="CITI Logo" style="height:28px"/></a>
          <button id="overlay-close" class="overlay-close" aria-label="Close" style="background:none;border:none;color:var(--muted);font-size:22px">&times;</button>
        </div>
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px">
          <li><a href="dashboard.html#products" style="color:var(--text);text-decoration:none">Commercial Banking</a></li>
          <li><a href="dashboard.html#solutions" style="color:var(--text);text-decoration:none">Offshore Banking</a></li>
          <li><a href="dashboard.html#resources" style="color:var(--text);text-decoration:none">Mortgage Banking</a></li>
          <li><a href="dashboard.html#about" style="color:var(--text);text-decoration:none">About</a></li>
        </ul>
      </div>
    </div>
  </header>

  <!-- secure banner -->
  <main class="container">
    <div class="grid">
      <section class="panel" aria-labelledby="transfer-title">
        <h1 id="transfer-title">Transfer funds</h1>

        <form id="transfer-form" class="transfer-form" novalidate>
          <div class="form-group">
            <label for="from-account">From</label>
            <select id="from-account" required>
              <option value="checking">Checking â€¢â€¢â€¢â€¢ 3364 â€” $62,345.67</option>
              <option value="savings">Savings â€¢â€¢â€¢â€¢ 5678 â€” $758,910.11</option>
            </select>
          </div>

          <div class="form-group">
            <label for="to-recipient">To</label>
            <input id="to-recipient" name="recipient" type="search" placeholder="Recipient name, email or account" required />
            <div class="muted" style="font-size:0.9rem;margin-top:6px">Tip: use saved recipients for faster transfers</div>
          </div>

          <div class="inline-row">
            <div style="flex:1" class="form-group">
              <label for="amount">Amount</label>
              <input id="amount" name="amount" type="number" step="0.01" min="0.01" placeholder="0.00" required />
            </div>
            <div style="width:220px" class="form-group">
              <label for="currency">Currency</label>
              <select id="currency"><option value="USD">USD</option><option value="EUR">EUR</option></select>
            </div>
          </div>

          <div class="form-group">
            <label for="memo">Memo (optional)</label>
            <input id="memo" type="text" placeholder="Invoice #, note for recipient" />
          </div>

          <div class="preview" aria-live="polite">
            <div class="preview-row"><div class="muted">From</div><div id="preview-from">Checking â€¢â€¢â€¢â€¢ 3364</div></div>
            <div class="preview-row"><div class="muted">To</div><div id="preview-to">â€”</div></div>
            <div class="preview-row"><div class="muted">Amount</div><div id="preview-amount">â€”</div></div>
            <div class="preview-row"><div class="muted">Currency</div><div id="preview-currency">USD</div></div>
          </div>

          <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
            <button class="btn-primary" id="transfer-submit" type="submit">Continue</button>
            <button class="btn-ghost" id="transfer-cancel" type="button">Cancel</button>
          </div>
        </form>
      </section>

      <aside>
        <div class="side-card panel">
          <h4>Saved recipients</h4>
          <div class="quick-list" id="saved-list">
            <button class="btn-ghost" data-recipient="ACME Inc. â€¢â€¢â€¢â€¢ 8877">$ CitiBank offshore. â€¢â€¢â€¢â€¢ 8877</button>
            <button class="btn-ghost" data-recipient="Jane Doe â€¢ jane@example.com">Jane Doe â€¢ jane@example.com</button>
          </div>
        </div>

        <div class="side-card panel" style="margin-top:12px">
          <h4>Safety tips</h4>
          <ul style="margin:8px 0 0 16px">
            <li class="muted">Double-check recipient details before confirming</li>
            <li class="muted">Use saved recipients for frequent transfers</li>
            <li class="muted">CITI will never ask for your password via email</li>
          </ul>
        </div>
      </aside>
    </div>
  </main>

  <!-- Confirmation modal -->
  <div class="modal-backdrop" id="confirm-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="confirm-title">
      <h3 id="confirm-title">Confirm transfer</h3>
      <div style="margin-top:10px">
        <div class="preview-row"><div class="muted">From</div><div id="confirm-from">â€”</div></div>
        <div class="preview-row"><div class="muted">To</div><div id="confirm-to">â€”</div></div>
        <div class="preview-row"><div class="muted">Amount</div><div id="confirm-amount">â€”</div></div>
        <div class="preview-row"><div class="muted">Memo</div><div id="confirm-memo">â€”</div></div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
        <button class="btn-ghost" id="confirm-cancel" type="button">Cancel</button>
        <button class="btn-primary" id="confirm-send" type="button">Send transfer</button>
      </div>
    </div>
  </div>

  <!-- Footer (shared style) -->
  <footer class="site-footer-adv" role="contentinfo" style="margin-top:32px">
    <div class="footer-inner">
      <div class="trust-row">
        <div class="trust-badge" aria-hidden="true">ðŸ”·</div>
        <div class="footer-meta">
        </div>
      </div>
      <nav class="footer-links" aria-label="Footer">
      </nav>
    </div>
  </footer>

<script>
/* Transfer page script â€” preserves dashboard helpers and patterns */

/* Helper formatters (kept consistent with dashboard) */
function fmtAmount(val){
  if (val === 0) return 'â€”';
  const abs = Math.abs(val).toLocaleString(undefined,{minimumFractionDigits:2});
  return (val < 0 ? 'âˆ’' : '+') + abs;
}
function formatLoginTimeISO(date){
  const opts = { month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit', hour12:true };
  return new Intl.DateTimeFormat('en-US', opts).format(date).replace(',', '').replace(' ', ' @ ');
}

/* Page initialization */
document.addEventListener('DOMContentLoaded', () => {
  // footer year
  const fy = document.getElementById('footer-year');
  if (fy) fy.textContent = new Date().getFullYear();

  // last-login read & persist (same key behavior as dashboard)
  (function(){
    const key = 'lastLogin';
    const stored = localStorage.getItem(key);
    const loginEl = document.querySelector('.member-line strong') || document.getElementById('member-name-top');
    const now = new Date();
    let dateObj = stored ? new Date(stored) : now;
    if (isNaN(dateObj.getTime())) dateObj = now;
    // update member-line timestamp if present
    const ml = document.querySelector('.member-line');
    if (ml) {
      // keep name text intact and append last login if desired elsewhere; in transfer page we preserve member display only
    }
    try { localStorage.setItem(key, new Date().toISOString()); } catch(e){}
  })();

  // overlay wiring (same as dashboard)
  const navBtn = document.getElementById('nav-toggle');
  const menuOverlay = document.getElementById('menu-overlay');
  const overlayClose = document.getElementById('overlay-close');
  const overlayBackdrop = document.getElementById('overlay-backdrop');
  if (navBtn && menuOverlay) {
    navBtn.addEventListener('click', () => { menuOverlay.style.display = 'block'; menuOverlay.setAttribute('aria-hidden','false'); });
  }
  if (overlayClose) overlayClose.addEventListener('click', () => { menuOverlay.style.display = 'none'; menuOverlay.setAttribute('aria-hidden','true'); });
  if (overlayBackdrop) overlayBackdrop.addEventListener('click', () => { menuOverlay.style.display = 'none'; menuOverlay.setAttribute('aria-hidden','true'); });

  // form elements
  const form = document.getElementById('transfer-form');
  const fromEl = document.getElementById('from-account');
  const toEl = document.getElementById('to-recipient');
  const amountEl = document.getElementById('amount');
  const currencyEl = document.getElementById('currency');
  const memoEl = document.getElementById('memo');

  // preview nodes
  const pFrom = document.getElementById('preview-from');
  const pTo = document.getElementById('preview-to');
  const pAmount = document.getElementById('preview-amount');
  const pCurrency = document.getElementById('preview-currency');

  // confirm modal nodes
  const confirmBackdrop = document.getElementById('confirm-backdrop');
  const confirmFrom = document.getElementById('confirm-from');
  const confirmTo = document.getElementById('confirm-to');
  const confirmAmount = document.getElementById('confirm-amount');
  const confirmMemo = document.getElementById('confirm-memo');
  const confirmCancel = document.getElementById('confirm-cancel');
  const confirmSend = document.getElementById('confirm-send');

  // saved recipients quick-fill
  document.getElementById('saved-list')?.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-recipient]');
    if (!btn) return;
    toEl.value = btn.getAttribute('data-recipient') || '';
    updatePreview();
  });

  // preview updater
  function updatePreview(){
    pFrom.textContent = fromEl.options[fromEl.selectedIndex]?.text || 'â€”';
    pTo.textContent = toEl.value.trim() || 'â€”';
    const amt = parseFloat(amountEl.value || '0');
    pAmount.textContent = amt ? ('$' + amt.toLocaleString(undefined,{minimumFractionDigits:2})) : 'â€”';
    pCurrency.textContent = currencyEl.value || 'USD';
  }

  // simple client-side validation
  function validate(){
    const recipient = toEl.value.trim();
    const amt = parseFloat(amountEl.value || '0');
    if (!recipient) return { ok:false, msg:'Enter a recipient' };
    if (!amt || amt <= 0) return { ok:false, msg:'Enter a valid amount' };
    return { ok:true };
  }

  // open confirm modal
  function openConfirm(){
    confirmFrom.textContent = pFrom.textContent;
    confirmTo.textContent = pTo.textContent;
    confirmAmount.textContent = pAmount.textContent + ' ' + pCurrency.textContent;
    confirmMemo.textContent = memoEl.value.trim() || 'â€”';
    confirmBackdrop.style.display = 'flex';
    confirmBackdrop.setAttribute('aria-hidden','false');
    confirmSend.focus();
  }

  function closeConfirm(){
    confirmBackdrop.style.display = 'none';
    confirmBackdrop.setAttribute('aria-hidden','true');
  }

  // events
  [fromEl, toEl, amountEl, currencyEl].forEach(el => el?.addEventListener && el.addEventListener('input', updatePreview));
  updatePreview();

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const ok = validate();
    if (!ok.ok) {
      alert(ok.msg);
      return;
    }
    openConfirm();
  });

  document.getElementById('transfer-cancel')?.addEventListener('click', () => { window.location.href = 'dashboard.html'; });

  confirmCancel?.addEventListener('click', () => { closeConfirm(); });
  confirmBackdrop?.addEventListener('click', (ev) => { if (ev.target === confirmBackdrop) closeConfirm(); });

  // confirm send: placeholder behavior preserving existing patterns (replace with real API call)
  confirmSend?.addEventListener('click', () => {
    confirmSend.disabled = true;
    confirmSend.textContent = 'Sendingâ€¦';
    // simulate network
    setTimeout(() => {
      confirmSend.disabled = false;
      confirmSend.textContent = 'Send transfer';
      closeConfirm();
      alert('Transfer submitted');
      window.location.href = 'dashboard.html'; // keep original navigation pattern
    }, 800);
  });

  // keyboard escape closes modal
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeConfirm(); });

});

document.addEventListener('click', e => {
  const btn = e.target.closest('.btn-primary-strong, .btn-ghost-strong');
  if (!btn) return;
  btn.style.transition = 'transform .08s';
  btn.style.transform = 'scale(.996)';
  setTimeout(()=> btn.style.transform = '', 120);
});
</script>
<script>
/* Drop-in: idempotent commit, update balances, append tx row, resilient print */
(function(){
  if (window.__citi_tx_installed) return;
  window.__citi_tx_installed = true;

  const BAL_KEY = 'citi_balances_prod';
  const TX_KEY  = 'citi_transactions_prod';
  const IN_FLIGHT_FLAG = '__citi_tx_inflight';

  function loadBalances(){ try { return JSON.parse(localStorage.getItem(BAL_KEY)) || { checking:62345.67, savings:758910.11 }; } catch(e){ return { checking:62345.67, savings:758910.11 }; } }
  function saveBalances(b){ localStorage.setItem(BAL_KEY, JSON.stringify(b)); }
  function loadTxs(){ try { return JSON.parse(localStorage.getItem(TX_KEY)) || []; } catch(e){ return []; } }
  function saveTxs(txs){ localStorage.setItem(TX_KEY, JSON.stringify(txs)); }

  function fmtCurrency(n){ return '$' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function prettyDateISO(d){ return new Date(d).toLocaleString(undefined, {month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit', hour12:true}); }

  function appendTxToDom(tx){
    const tbody = document.querySelector('#tx-tbody') || document.querySelector('table.transactions tbody');
    if (!tbody) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${prettyDateISO(tx.date)}</td><td>${tx.desc || tx.to || tx.from}</td><td class="text-right">${fmtCurrency(tx.amount)}</td><td class="text-right">${fmtCurrency(tx.balance)}</td>`;
    tbody.insertBefore(tr, tbody.firstChild);
    if (tbody.children.length > 200) tbody.removeChild(tbody.lastChild);
  }

  function printReceiptResilient(tx){
    // Try popup
    try {
      const popup = window.open('', '_blank', 'width=520,height=720,scrollbars=yes');
      if (popup) {
        const doc = popup.document;
        doc.open();
        doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Receipt</title>
          <style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;padding:20px;color:#07101a} .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee}.total{font-weight:800}</style>
          </head><body>
          <h2>Transaction Receipt</h2>
          <div class="row"><div>Date</div><div>${prettyDateISO(tx.date)}</div></div>
          <div class="row"><div>From</div><div>${tx.from}</div></div>
          <div class="row"><div>To</div><div>${tx.to || 'â€”'}</div></div>
          <div class="row"><div>Amount</div><div class="total">${fmtCurrency(tx.amount)}</div></div>
          <div class="row"><div>Balance</div><div>${fmtCurrency(tx.balance)}</div></div>
          <div style="margin-top:12px;color:#666;font-size:12px">Reference: ${tx.id}</div>
          <script>window.onload=function(){ setTimeout(()=>{ try{ window.print(); }catch(e){} setTimeout(()=>window.close(),600); },120); };</script>
          </body></html>`);
        doc.close();
        return;
      }
    } catch(e){ /* ignore and fallback */ }

    // Fallback overlay in-page
    if (document.getElementById('citi-print-overlay')) return;
    const overlay = document.createElement('div');
    overlay.id = 'citi-print-overlay';
    overlay.style = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;padding:20px;';
    overlay.innerHTML = `
      <div style="background:#fff;color:#07101a;border-radius:12px;max-width:520px;width:100%;padding:20px;box-shadow:0 20px 60px rgba(2,6,23,0.6);">
        <h2 style="margin:0 0 8px">Transaction Receipt</h2>
        <div style="font-size:13px;color:#555;margin-bottom:12px">${prettyDateISO(tx.date)}</div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #eee"><div>From</div><div>${tx.from}</div></div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #eee"><div>To</div><div>${tx.to||'â€”'}</div></div>
        <div style="display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid #eee;font-weight:700"><div>Amount</div><div>${fmtCurrency(tx.amount)}</div></div>
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #eee"><div>Balance</div><div>${fmtCurrency(tx.balance)}</div></div>
        <div style="margin-top:12px;color:#777;font-size:12px">Reference: ${tx.id}</div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px">
          <button id="citi-print-close" style="padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer">Close</button>
          <button id="citi-print-now" style="padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,#8F6BFF,#00D4FF);color:#07101a;cursor:pointer">Print</button>
        </div>
      </div>`;
    document.body.appendChild(overlay);
    document.getElementById('citi-print-close').addEventListener('click', ()=> overlay.remove());
    document.getElementById('citi-print-now').addEventListener('click', ()=> {
      const printWin = window.open('', '_blank', 'width=520,height=720');
      if (!printWin) { alert('Popup blocked. Allow popups to print.'); return; }
      printWin.document.open();
      printWin.document.write('<!doctype html><html><head><meta charset="utf-8"><title>Receipt</title><style>body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;padding:20px;color:#07101a}</style></head><body>');
      printWin.document.write(overlay.querySelector('div').outerHTML);
      printWin.document.write('<script>window.onload=function(){ setTimeout(()=>{ window.print(); setTimeout(()=>window.close(),400); },120); }<\/script></body></html>');
      printWin.document.close();
    });
  }

  function commitTransaction(opts){
    if (window[IN_FLIGHT_FLAG]) return null;
    window[IN_FLIGHT_FLAG] = true;
    try {
      const balances = loadBalances();
      const txs = loadTxs();
      const from = (opts.from || 'checking').toLowerCase();
      const amount = Number(opts.amount) || 0;
      if (!amount || amount <= 0) throw new Error('Invalid amount');
      if (typeof balances[from] !== 'number') balances[from] = Number(balances[from]) || 0;
      balances[from] = Number((balances[from] - amount).toFixed(2));
      saveBalances(balances);
      const tx = {
        id: 'tx_' + Date.now(),
        date: new Date().toISOString(),
        type: opts.type || 'transfer',
        from: from,
        to: opts.to || opts.recipient || '',
        desc: opts.desc || (opts.type === 'withdraw' ? 'Withdrawal' : 'Transfer'),
        amount: -Math.abs(amount),
        balance: balances[from]
      };
      txs.unshift(tx);
      saveTxs(txs);
      window.transactions = txs.slice();
      appendTxToDom(tx);
      printReceiptResilient(tx);
      return tx;
    } finally {
      // release inflight after slight delay so UI animations complete
      setTimeout(()=> { try { window[IN_FLIGHT_FLAG] = false; } catch(e){} }, 600);
    }
  }

  function hookConfirmButton(){
    const btn = document.getElementById('confirm-send') || document.querySelector('[data-action="confirm-send"]') || document.querySelector('button[id*="confirm"]') || null;
    if (!btn) return;
    if (btn.dataset.citiHook === '1') return;
    btn.dataset.citiHook = '1';
    btn.addEventListener('click', function(ev){
      ev.preventDefault();
      // Prevent double clicks at the handler level
      if (btn.dataset.citiProcessing === '1') return;
      btn.dataset.citiProcessing = '1';
      setTimeout(()=> { btn.dataset.citiProcessing = '0'; }, 1200);

      const fromEl = document.getElementById('from-account') || document.querySelector('.from-account');
      const amountEl = document.getElementById('amount') || document.querySelector('input[name="amount"]') || document.querySelector('input[type="number"]');
      const toEl = document.getElementById('to-recipient') || document.getElementById('external-account') || document.querySelector('[name="recipient"]') || null;
      const type = (location.pathname.indexOf('withdraw') !== -1) ? 'withdraw' : 'transfer';
      const from = fromEl ? (fromEl.value || fromEl.textContent || '').toLowerCase().split(' ')[0] : 'checking';
      const amount = amountEl ? parseFloat((amountEl.value || amountEl.textContent || '0').replace(/[^0-9.\-]/g,'')) : 0;
      const to = toEl ? (toEl.value || toEl.textContent || '') : '';

      if (!amount || amount <= 0) { alert('Enter a valid amount'); btn.dataset.citiProcessing='0'; return; }
      try {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = 'Processingâ€¦';
        const tx = commitTransaction({ type, from, to, amount, desc: type === 'withdraw' ? 'Withdrawal' : 'Transfer' });
        setTimeout(()=> {
          btn.disabled = false;
          btn.textContent = originalText;
          const backdrop = document.getElementById('confirm-backdrop');
          if (backdrop) backdrop.style.display = 'none';
          try { location.assign('dashboard.html'); } catch(e){}
        }, 700);
      } catch(err){
        alert('Transaction failed: ' + (err && err.message ? err.message : 'unknown'));
        btn.disabled = false;
        btn.dataset.citiProcessing = '0';
      }
    });
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', hookConfirmButton);
  else hookConfirmButton();

  // expose for manual use and debugging
  window.commitTransaction = commitTransaction;
  window.citiBalancesLoad = loadBalances;
  window.citiTxsLoad = loadTxs;
})();
</script>

</body>
</html>

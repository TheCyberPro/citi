<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transfer Success — CITI</title>
  <style>
    :root{ --bg:#0f1724; --muted:#9aa4b2; --accent:#7c5cff; --glass: rgba(255,255,255,0.03); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; }
    html,body{height:100%;margin:0}
    body{background:linear-gradient(120deg, rgba(15,23,36,1), rgba(10,14,22,1)); color:#e6eef8; display:flex;align-items:center;justify-content:center;padding:20px}
    .card{width:760px;max-width:96%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    h1{margin:0 0 8px}
    .muted{color:var(--muted);font-size:13px}
    .btn{padding:12px 16px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#5ec9ff);font-weight:700;color:#08101a;cursor:pointer}
    .btn-ghost{padding:10px 12px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer}
    .receipt{background:#fff;color:#111;padding:14px;border-radius:10px;margin-top:12px}
    @media print { body *{visibility:hidden} #receiptPrintable, #receiptPrintable *{visibility:visible} #receiptPrintable{position:fixed;left:0;top:0;width:100%} }
  </style>
</head>
<body>
  <div class="card" id="page">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1 id="heading">Confirm transfer</h1>
        <div class="muted" id="sub">Enter your transaction PIN to complete the transfer</div>
      </div>
      <div class="muted" id="balanceTop"></div>
    </div>

    <div id="pinStep" style="margin-top:18px">
      <label class="muted" for="pin">Transaction PIN</label>
      <input id="pin" type="password" inputmode="numeric" maxlength="6" style="padding:10px;border-radius:8px;width:140px;margin-top:8px" />
      <div style="display:flex;gap:12px;margin-top:12px">
        <button id="verifyBtn" class="btn">Verify PIN & Complete</button>
        <button id="cancelBtn" class="btn-ghost">Cancel</button>
      </div>
    </div>

    <div id="successStep" style="display:none;margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700;font-size:18px" id="successTitle">Transfer completed</div>
          <div class="muted" id="successMeta">Transaction recorded and added to your history</div>
        </div>
        <div>
          <button id="printReceiptBtn" class="btn">Print receipt</button>
          <button id="backDashboard" class="btn-ghost">Go to Dashboard</button>
        </div>
      </div>

      <div class="receipt" id="receiptPrintable" aria-hidden="false">
        <!-- Populated dynamically -->
      </div>
    </div>
  </div>

  <script>
    // Reuse storage keys
    const BALANCE_KEY = 'balance';
    const TX_KEY = 'transactions';
    const CURRENCY = 'USD';

    function safeParse(key,fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } }
    function formatCurrency(a){ try { return new Intl.NumberFormat(undefined, { style:'currency', currency: CURRENCY }).format(a); } catch { return CURRENCY + ' ' + Number(a).toFixed(2); } }
    function findTxById(id){ const txs = safeParse(TX_KEY, []); return txs.find(t=>t.id === id); }
    function getBalance(){ const b = safeParse(BALANCE_KEY, { amount:0, currency: CURRENCY }); return { amount: Number(b.amount)||0, currency: b.currency||CURRENCY }; }

    // Read tx id from query or lastTxId fallback
    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search); return params.get(name);
    }

    const txId = getQueryParam('tx') || localStorage.getItem('lastTxId');

    // UI elements
    const pinStep = document.getElementById('pinStep');
    const successStep = document.getElementById('successStep');
    const verifyBtn = document.getElementById('verifyBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const heading = document.getElementById('heading');
    const sub = document.getElementById('sub');
    const balanceTop = document.getElementById('balanceTop');
    const receiptPrintable = document.getElementById('receiptPrintable');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const backDashboard = document.getElementById('backDashboard');

    // Show balance up top
    function renderTopBalance(){ const b = getBalance(); balanceTop.textContent = 'Available ' + formatCurrency(b.amount); }
    renderTopBalance();

    // Basic PIN verification simulation: accept 'HART1' as valid
    verifyBtn.addEventListener('click', function(){
      const pin = document.getElementById('pin').value.trim();
      if(pin.length < 4){ alert('Enter your PIN'); return; }
      // simulated check
      if(pin !== '123456'){ if(!confirm('Incorrect PIN.')) return; }
      completeTransfer();
    });

    cancelBtn.addEventListener('click', function(){ window.location.href = 'transfer.html'; });

    function completeTransfer(){
      const tx = txId ? findTxById(txId) : null;
      if(!tx){ alert('Transaction not found. Returning to transfer screen.'); window.location.href = 'transfer.html'; return; }
      // Show success UI
      pinStep.style.display = 'none';
      successStep.style.display = 'block';
      heading.textContent = 'Transfer success';
      sub.textContent = 'You can print the receipt or go back to dashboard';
      // Populate receiptPrintable
      receiptPrintable.innerHTML = `
        <div style="font-weight:700;font-size:18px;margin-bottom:8px">Transaction Receipt</div>
        <div style="font-size:13px;color:#666;margin-bottom:8px">Transaction ID: ${escapeHtml(tx.id)}</div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Recipient</strong></div><div>${escapeHtml(tx.recipientName)}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Account</strong></div><div>${escapeHtml(tx.toAccount)}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Bank code</strong></div><div>${escapeHtml(tx.bankCode||'—')}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Amount</strong></div><div style="font-weight:800">${formatCurrency(tx.amount)}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Note</strong></div><div>${escapeHtml(tx.description||'—')}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Date</strong></div><div>${new Date(tx.timestamp).toLocaleString()}</div></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><div><strong>Status</strong></div><div>${tx.success ? 'Completed' : 'Failed'}</div></div>
      `;
      renderTopBalance();
    }

    // Print receipt button
    printReceiptBtn.addEventListener('click', function(){ window.print(); });

    backDashboard.addEventListener('click', function(){ window.location.href = 'dashboard.html'; });

    // escape helper
    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]); }

    // If txId missing, redirect back to transfer
    (function init(){
      if(!txId){ alert('No transaction id found. Returning to transfer screen.'); window.location.href = 'transfer.html'; return; }
      // show PIN step; optionally show tx summary for confirmation
      const tx = findTxById(txId);
      if(!tx){ alert('Transaction not found. Returning to transfer screen.'); window.location.href = 'transfer.html'; return; }
      // show small summary in page header
      document.getElementById('sub').textContent = `Transfer $${Number(tx.amount).toFixed(2)} to ${tx.recipientName}. Enter PIN to complete.`;
      renderTopBalance();
    })();
  </script>
</body>
</html>
